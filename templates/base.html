{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}T42 Tetis{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome para √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* Navbar fixa no topo */
        .navbar {
            width: 100%;
            background: #b8bbc9;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            padding: 10px 20px;
            font-family:sans-serif
        }

        .main-content {
            margin-top: 80px;
            padding: 20px;
            text-align: center;
        }

        /* Mant√©m os dropdowns e submenus abertos corretamente */
        .dropdown-menu {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Corrige os submenus para ficarem ABAIXO e n√£o ao lado */
        .dropdown-submenu {
            position: relative;
        }

        .dropdown-submenu .dropdown-menu {
            position: static;
            display: none;
            width: 100%;
        }

        .dropdown-submenu:hover .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
        }

        .dropdown-item i {
            margin-right: 8px;
        }

        /* Estilos para a lista de alertas */
        .alertas-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: popupSlideIn 0.5s ease-out;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .alertas-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .alertas-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .alertas-subtitle {
            font-size: 1rem;
            opacity: 0.8;
        }

        .alertas-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .alerta-item {
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            animation: alertaSlideIn 0.3s ease-out;
        }

        .alerta-item.porta-aberta {
            border-left-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }

        .alerta-item.porta-fechada {
            border-left-color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
        }

        .alerta-item.luminosidade {
            border-left-color: #ffa726;
            background: rgba(255, 167, 38, 0.1);
        }

        .alerta-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            min-width: 30px;
            text-align: center;
        }

        .alerta-content {
            flex: 1;
        }

        .alerta-equipamento {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .alerta-descricao {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .alerta-valor {
            font-weight: bold;
            color: #ffa726;
        }

        .popup-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            margin-top: 20px;
            width: 100%;
        }

        .popup-close:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            animation: overlayFadeIn 0.3s ease-out;
        }

        @keyframes alertaSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes overlayFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Responsividade para mobile */
        @media (max-width: 768px) {
            .alertas-popup {
                padding: 20px;
                max-width: 95%;
                max-height: 85vh;
            }
            
            .alertas-title {
                font-size: 1.5rem;
            }
            
            .alertas-subtitle {
                font-size: 0.9rem;
            }
            
            .alerta-item {
                padding: 12px;
            }
            
            .alerta-equipamento {
                font-size: 1rem;
            }
            
            .alerta-descricao {
                font-size: 0.8rem;
            }
            
            .alerta-icon {
                font-size: 1.2rem;
                margin-right: 10px;
            }
        }
    </style>
</head>

<audio id="alarme-audio" src="/static/som-alerta.mp3" preload="auto"></audio>
<script>
// Controle de estados anteriores para evitar repeti√ß√µes
let estadosAnteriores = new Map(); // guid -> { porta: status, luminosidade: valor }
let alertasAtivos = new Set(); // Para controlar alertas j√° mostrados

// Fun√ß√£o para limpar cache quando trocar de tela
function limparCacheAlertas() {
  estadosAnteriores.clear();
  alertasAtivos.clear();
  console.log("üßπ Cache de alertas limpo");
  
  // Mostra notifica√ß√£o visual
  const notification = document.createElement('div');
  notification.textContent = 'üßπ Cache de alertas limpo!';
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #3742fa;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    z-index: 10002;
    font-size: 14px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  `;
  document.body.appendChild(notification);
  
  // Remove a notifica√ß√£o ap√≥s 3 segundos
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 3000);
}

// Fun√ß√£o para limpar cache silenciosamente (sem mostrar todos os alertas)
function limparCacheSilencioso() {
  estadosAnteriores.clear();
  alertasAtivos.clear();
  console.log("üßπ Cache de alertas limpo silenciosamente");
}

// Fun√ß√£o para mostrar status atual de todos os equipamentos
function mostrarStatusAtual() {
  console.log("üìä Status atual dos equipamentos:");
  console.log(estadosAnteriores);
  
  let statusText = "üìä Status Atual dos Equipamentos:\n\n";
  
  if (estadosAnteriores.size === 0) {
    statusText += "Nenhum equipamento monitorado ainda.";
  } else {
    estadosAnteriores.forEach((estado, guid) => {
      const portaStatus = estado.porta === null ? "‚ùì Desconhecido" : 
                         estado.porta === 1 ? "üö™ Aberta" : "üîí Fechada";
      const luzStatus = estado.luminosidade === null ? "‚ùì Desconhecido" : 
                       `${estado.luminosidade} lux`;
      
      statusText += `GUID: ${guid.substring(0, 8)}...\n`;
      statusText += `  Porta: ${portaStatus}\n`;
      statusText += `  Luminosidade: ${luzStatus}\n\n`;
    });
  }
  
  // Mostra em um popup
  const popup = document.createElement('div');
  popup.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border: 2px solid #3742fa;
    border-radius: 10px;
    padding: 20px;
    z-index: 10003;
    max-width: 500px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  `;
  
  popup.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3 style="margin: 0; color: #3742fa;">Status Atual</h3>
      <button onclick="this.parentElement.parentElement.remove()" style="background: #ff6b6b; color: white; border: none; border-radius: 3px; padding: 5px 10px; cursor: pointer;">‚úï</button>
    </div>
    <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; margin: 0;">${statusText}</pre>
  `;
  
  document.body.appendChild(popup);
}

// Limpa cache quando a p√°gina √© carregada/recarregada
window.addEventListener('load', limparCacheSilencioso);
window.addEventListener('beforeunload', limparCacheSilencioso);

// Limpa cache quando h√° mudan√ßa de URL (navega√ß√£o)
let currentUrl = window.location.href;
setInterval(() => {
  if (window.location.href !== currentUrl) {
    currentUrl = window.location.href;
    limparCacheSilencioso();
  }
}, 1000);

function showAlertasLista(eventos) {
  // Remove popup anterior se existir
  const existingPopup = document.querySelector('.alertas-popup');
  const existingOverlay = document.querySelector('.popup-overlay');
  if (existingPopup) existingPopup.remove();
  if (existingOverlay) existingOverlay.remove();

  // Cria overlay
  const overlay = document.createElement('div');
  overlay.className = 'popup-overlay';
  document.body.appendChild(overlay);

  // Cria popup da lista
  const popup = document.createElement('div');
  popup.className = 'alertas-popup';

  // Filtra apenas eventos que representam mudan√ßas reais
  const eventosFiltrados = eventos.filter(evento => {
    const guid = evento.guid;
    const estadoAnterior = estadosAnteriores.get(guid) || { porta: null, luminosidade: null };
    
    console.log(`üîç Filtrando evento: ${evento.evento} para ${evento.equipamento} (GUID: ${guid})`);
    console.log(`üìä Estado anterior:`, estadoAnterior);
    
    if (evento.evento === 'aberta' || evento.evento === 'fechada') {
      const novoStatus = evento.evento === 'aberta' ? 1 : 0;
      console.log(`üö™ Novo status da porta: ${novoStatus}, Status anterior: ${estadoAnterior.porta}`);
      
      // Se √© a primeira vez que vemos este equipamento, apenas registra o estado sem mostrar alerta
      if (estadoAnterior.porta === null) {
        estadosAnteriores.set(guid, { ...estadoAnterior, porta: novoStatus });
        console.log(`üìù Estado inicial registrado para ${evento.equipamento}: porta ${evento.evento}`);
        return false; // N√£o mostra alerta na primeira vez
      }
      
      // S√≥ mostra alerta se houve mudan√ßa real de status
      if (estadoAnterior.porta !== novoStatus) {
        estadosAnteriores.set(guid, { ...estadoAnterior, porta: novoStatus });
        console.log(`‚úÖ Evento de porta ${evento.evento} ACEITO (mudan√ßa real)`);
        return true;
      } else {
        console.log(`‚ùå Evento de porta ${evento.evento} REJEITADO (sem mudan√ßa)`);
        return false;
      }
    }
    
    if (evento.evento === 'luz') {
      console.log(`üí° Luminosidade: ${evento.valor}, Valor anterior: ${estadoAnterior.luminosidade}`);
      
      // Se √© a primeira vez que vemos luminosidade deste equipamento, apenas registra
      if (estadoAnterior.luminosidade === null) {
        estadosAnteriores.set(guid, { ...estadoAnterior, luminosidade: evento.valor });
        console.log(`üìù Estado inicial de luminosidade registrado para ${evento.equipamento}: ${evento.valor}`);
        return false; // N√£o mostra alerta na primeira vez
      }
      
      // S√≥ mostra alerta se houve mudan√ßa real
      if (estadoAnterior.luminosidade !== evento.valor) {
        estadosAnteriores.set(guid, { ...estadoAnterior, luminosidade: evento.valor });
        console.log(`‚úÖ Evento de luminosidade ACEITO (mudan√ßa real)`);
        return true;
      } else {
        console.log(`‚ùå Evento de luminosidade REJEITADO (sem mudan√ßa)`);
        return false;
      }
    }
    
    console.log(`‚ùì Evento desconhecido: ${evento.evento}`);
    return false;
  });

  console.log(`üìã Total de eventos recebidos: ${eventos.length}`);
  console.log(`‚úÖ Eventos filtrados (mudan√ßas reais): ${eventosFiltrados.length}`);
  
  // Se n√£o h√° eventos filtrados, n√£o mostra popup
  if (eventosFiltrados.length === 0) {
    console.log(`‚ùå Nenhum evento filtrado, removendo overlay`);
    overlay.remove();
    return;
  }

  // Gera HTML da lista
  let alertasHTML = '';
  eventosFiltrados.forEach(evento => {
    let icon, descricao, classe;
    
    switch(evento.evento) {
      case 'aberta':
        icon = 'üö®';
        descricao = 'Porta aberta detectada';
        classe = 'porta-aberta';
        break;
      case 'fechada':
        icon = '‚úÖ';
        descricao = 'Porta fechada';
        classe = 'porta-fechada';
        break;
      case 'luz':
        icon = 'üí°';
        descricao = `Luminosidade alta: <span class="alerta-valor">${evento.valor} lux</span>`;
        classe = 'luminosidade';
        break;
    }

    alertasHTML += `
      <li class="alerta-item ${classe}">
        <div class="alerta-icon">${icon}</div>
        <div class="alerta-content">
          <div class="alerta-equipamento">${evento.equipamento}</div>
          <div class="alerta-descricao">${descricao}</div>
        </div>
      </li>
    `;
  });

  popup.innerHTML = `
    <div class="alertas-header">
      <div class="alertas-title">üö® ALERTAS DETECTADOS</div>
      <div class="alertas-subtitle">${eventosFiltrados.length} evento(s) encontrado(s)</div>
    </div>
    <ul class="alertas-list">
      ${alertasHTML}
    </ul>
    <button class="popup-close" onclick="closeAlertasPopup()">Fechar</button>
  `;

  document.body.appendChild(popup);

  // Auto-close ap√≥s 8 segundos (mais r√°pido)
  setTimeout(() => {
    closeAlertasPopup();
  }, 8000);
}

function closeAlertasPopup() {
  const popup = document.querySelector('.alertas-popup');
  const overlay = document.querySelector('.popup-overlay');
  if (popup) popup.remove();
  if (overlay) overlay.remove();
}

function verificarPorta() {
  // Adiciona timestamp para evitar requisi√ß√µes simult√¢neas
  if (verificarPorta.isRunning) {
    console.log("‚è≥ Verifica√ß√£o j√° em andamento, pulando...");
    return;
  }
  
  verificarPorta.isRunning = true;
  
  fetch("{% url 'verificar_fdoor' %}")
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      const audio = document.getElementById("alarme-audio");

      // Debug: Log da resposta completa
      console.log("üì° Resposta da API:", data);

      // Atualiza status para sucesso
      if (window.updateStatusSuccess) {
        window.updateStatusSuccess();
      }

      // Verifica se h√° eventos na resposta
      if (data.eventos && data.eventos.length > 0) {
        console.log("üéØ Eventos recebidos:", data.eventos);
        
        // Toca o som apenas uma vez se houver eventos
        if (audio) {
          audio.play().catch(err => console.log("Erro ao tocar som:", err));
        }
        
        // Mostra lista de alertas com filtro de repeti√ß√µes
        showAlertasLista(data.eventos);
      }
      
      // Log para debug (opcional)
      if (data.total_eventos > 0) {
        console.log(`Detectados ${data.total_eventos} eventos`);
      }
    })
    .catch(error => {
      console.error("Erro ao verificar porta:", error);
      
      // Atualiza status para erro
      if (window.updateStatusError) {
        window.updateStatusError();
      }
    })
    .finally(() => {
      verificarPorta.isRunning = false;
    });
}

// Inicia verifica√ß√£o autom√°tica a cada 10 segundos (mais est√°vel)
setInterval(verificarPorta, 10000);

// Primeira verifica√ß√£o imediata
setTimeout(verificarPorta, 1000);

// Verifica√ß√£o extra r√°pida para eventos cr√≠ticos (a cada 5 segundos)
let verificacaoRapida = setInterval(() => {
  // S√≥ faz verifica√ß√£o r√°pida se n√£o houver popup ativo
  const popupAtivo = document.querySelector('.alertas-popup');
  if (!popupAtivo) {
    verificarPorta();
  }
}, 5000);

// Fun√ß√£o de teste para simular eventos de porta fechada
function testarPortaFechada() {
  console.log("üß™ TESTE: Simulando evento de porta fechada");
  
  const eventoTeste = {
    eventos: [
      {
        evento: 'fechada',
        equipamento: 'TESTE - Equipamento 001',
        guid: 'test-guid-001'
      }
    ],
    total_eventos: 1,
    total_equipamentos: 533
  };
  
  showAlertasLista(eventoTeste.eventos);
}

// Adiciona indicador de status e bot√£o de teste
setTimeout(() => {
  // Indicador de status
  const statusIndicator = document.createElement('div');
  statusIndicator.id = 'status-indicator';
  statusIndicator.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10001;
    padding: 8px 12px;
    background: #2ed573;
    color: white;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  `;
  statusIndicator.textContent = 'üü¢ SISTEMA ATIVO';
  document.body.appendChild(statusIndicator);

  // Bot√£o de teste
  const testButton = document.createElement('button');
  testButton.textContent = 'üß™ Testar Porta Fechada';
  testButton.style.cssText = `
    position: fixed;
    top: 60px;
    right: 20px;
    z-index: 10001;
    padding: 10px;
    background: #ff6b6b;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
  `;
  testButton.onclick = testarPortaFechada;
  document.body.appendChild(testButton);

  // Bot√£o para limpar cache
  const clearCacheButton = document.createElement('button');
  clearCacheButton.textContent = 'üßπ Limpar Cache';
  clearCacheButton.style.cssText = `
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 10001;
    padding: 10px;
    background: #3742fa;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
  `;
  clearCacheButton.onclick = limparCacheAlertas;
  document.body.appendChild(clearCacheButton);

  // Bot√£o para mostrar estado atual
  const statusButton = document.createElement('button');
  statusButton.textContent = 'üìä Status Atual';
  statusButton.style.cssText = `
    position: fixed;
    top: 140px;
    right: 20px;
    z-index: 10001;
    padding: 10px;
    background: #2ed573;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
  `;
  statusButton.onclick = mostrarStatusAtual;
  document.body.appendChild(statusButton);

  // Atualiza indicador de status
  setInterval(() => {
    const indicator = document.getElementById('status-indicator');
    if (indicator) {
      const now = new Date();
      const time = now.toLocaleTimeString();
      indicator.textContent = `üü¢ ATIVO ${time}`;
      indicator.style.background = '#2ed573';
    }
  }, 1000);

  // Fun√ß√£o para atualizar status em caso de erro
  window.updateStatusError = function() {
    const indicator = document.getElementById('status-indicator');
    if (indicator) {
      indicator.textContent = 'üî¥ ERRO API';
      indicator.style.background = '#ff4757';
    }
  };

  // Fun√ß√£o para atualizar status em caso de sucesso
  window.updateStatusSuccess = function() {
    const indicator = document.getElementById('status-indicator');
    if (indicator) {
      indicator.textContent = 'üü¢ ATIVO';
      indicator.style.background = '#2ed573';
    }
  };
}, 2000);
</script>
    
<body>

<!-- Navbar dentro do quadro arredondado -->
<div class="navbar-container">
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">GS Controller</a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <i class="fas fa-bars"></i>
            </button>

            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a href="{% url 'home' %}" class="nav-link"><i class="fas fa-house-user"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'mapa' %}" class="nav-link"><i class="fas fa-map-location-dot"></i> Mapa</a>
                    </li>
                    <li class="nav-item">
                        <a href="/scanner/" class="nav-link"><i class="fas fa-qrcode"></i> Scanner</a>
                    </li>
                </ul>
            </div>

            <!-- Bot√£o de Logout -->
            <form id="logout-form" action="{% url 'logout' %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </form>
        </div>
    </nav>
</div>

<!-- Conte√∫do Principal -->
<main class="main-content">
    {% block content %}{% endblock %}
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
